# 企查查招聘接口逆向说明

> 本文档整理企查查 `bigsearch/recruit` 招聘搜索接口的完整逆向过程，包括遇到的问题、针对性解决方案及最终加解密逻辑。

---

## 一、目标接口

| 项目 | 说明 |
|------|------|
| 页面 URL | `https://www.qcc.com/web/bigsearch/recruit?searchKey=关键词` |
| 接口 URL | `https://www.qcc.com/api/bigsearch/recruit` |
| 请求方法 | GET |
| 风控方式 | 动态请求头 `i` / `u`（HMAC-SHA512 签名） |

---

## 二、遇到的问题与解决方案

### 问题 1：接口返回 435 未知错误

**现象**：使用 `requests` 直接请求接口，返回 `{"status":435,"message":"未知错误","errcode":""}`。

**原因**：企查查对接口请求做了签名校验，请求头中必须包含一对动态生成的 `key: value`（记为 `i` 和 `u`），由服务端验证，缺失或错误即返回 435。

**解决**：从网页 JS 中还原签名算法，用 Node.js / execjs 在 Python 中复现，生成正确的 `i` / `u` 并加入请求头。

---

### 问题 2：Cookie 过期导致 435

**现象**：即使签名逻辑正确，仍返回 435。

**原因**：Cookie 与当前浏览器会话不一致或已过期，服务端判定为非法请求。

**解决**：每次运行前从浏览器 Network 面板复制**当前页面**的 Cookie，粘贴到脚本中使用。Cookie 需与 `window.pid`、`window.tid` 来自同一会话。

---

### 问题 3：`main_export is not defined`

**现象**：`execjs._exceptions.ProgramError: ReferenceError: main_export is not defined`

**原因**：JS 文件中只定义了 `main`，Python 中调用了不存在的 `main_export`。

**解决**：将 Python 中的 `js_exec.call("main_export", e)` 改为 `js_exec.call("main", e)`，或是在 JS 末尾增加 `function main_export(e){return main(e)}`。

---

### 问题 4：生成的 i/u 与浏览器不一致，仍返回 435

**现象**：JS 能正常执行并返回 `{i, u}`，但与浏览器抓包中的动态头不一致，请求仍 435。

**原因**：对 **GET** 请求，网页实际签名使用的 path 是**带完整 query 的 URL 路径**，且整体做了 `toLowerCase()`，`data` 传空对象 `{}`。之前错误地传了 `/api/bigsearch/recruit` + `data=params`。

**解决**：按 `new_qichacha.js` 中 433912 模块的逻辑：

1. 将 `params` 按 key 排序后用 `urlencode` 拼成 query；
2. path 设为 `/api/bigsearch/recruit?` + query，整体 `.lower()`；
3. 传给 JS 的 `data` 设为 `{}`。

---

### 问题 5：`tid` 未更新

**现象**：JS 中 `global.tid` 为写死的旧值，与当前页面不一致。

**原因**：`tid` 来自 `window.tid`，每次打开页面可能变化。

**解决**：在 `aa` 函数开头增加 `if (e.tid) global.tid = e.tid;`，由 Python 传入当前 `window.tid`。

---

## 三、逆向加解密逻辑

### 3.1 整体流程

```
1. 访问 recruit 静态页面 → 获取 window.pid（用于 x-pid 请求头）
2. 在浏览器控制台执行 window.tid → 获取 tid
3. 构建 path（GET 需带完整 query 并小写）
4. 调用 JS main(e) → 得到 {i, u}
5. 将 i 作为 header 名、u 作为 header 值加入请求
6. 携带 cookie、x-pid、referer 等发送请求
```

### 3.2 签名算法（i 和 u）

#### 3.2.1 密钥生成 `dd(path)`（对应 o.default）

- 输入：path 字符串（如 `/api/bigsearch/recruit?city=&...`）
- 逻辑：`path` 转小写后复制一份拼接，对每个字符 `charCodeAt() % 20` 得到索引，用 `mapping` 表映射成新字符
- 输出：密钥字符串，用于 HMAC

```javascript
// mapping 表 (0~19)
mapping = {
  "0":"W","1":"l","2":"k","3":"B","4":"Q","5":"g","6":"f","7":"i","8":"i",
  "9":"r","10":"v","11":"6","12":"A","13":"K","14":"N","15":"k","16":"4",
  "17":"L","18":"1","19":"8"
}
```

#### 3.2.2 计算 i（对应 bb / 36321）

- 输入：`path`（小写）、`data`（GET 时为 `{}`）
- 公式：`i = HMAC-SHA512(path + JSON.stringify(data).toLowerCase(), dd(path)).toLowerCase().substr(8, 20)`
- 输出：20 位十六进制字符串，作为动态 header 的**键名**

#### 3.2.3 计算 u（对应 r_default / 328323）

- 输入：`path`、`data`、`tid`（来自 `window.tid`）
- 公式：`u = HMAC-SHA512(path + "pathString" + JSON.stringify(data).toLowerCase() + tid, dd(path))`
- 输出：完整 HMAC 十六进制字符串，作为动态 header 的**键值**

### 3.3 GET 与 POST 的差异

| 类型 | path | data |
|------|------|------|
| GET | `/api/xxx?key1=val1&key2=val2`（完整 query，整体小写） | `{}` |
| POST | `/api/xxx` | 请求体 JSON 对象 |

---

## 四、文件结构

```
项目目录/
├── 02_企查查_header加密逻辑.js   # 签名算法（dd/bb/r_default/aa/main）
├── encode_url.py                 # URL 中文编码
├── test.py                       # 招聘接口测试脚本
├── new_qichacha.js               # 原始网页 JS（用于对照分析）
└── 企查查招聘接口逆向说明.md     # 本文档
```

---

## 五、使用步骤

1. **打开招聘页面**：`https://www.qcc.com/web/bigsearch/recruit?searchKey=体育`
2. **获取 Cookie**：F12 → Network → 任选一个 `www.qcc.com` 请求 → Request Headers → 复制 `cookie` 整行
3. **获取 tid**：F12 → Console → 输入 `window.tid` → 复制返回值
4. **运行脚本**：`python test.py`，按提示粘贴 Cookie、tid、搜索关键字

---

## 六、核心代码片段

### 6.1 Python：构建 path 并调用 JS

```python
from urllib.parse import urlencode

def gen_i_u(path: str, params: dict, tid: str, is_get: bool = True) -> dict:
    if is_get and params:
        qs = urlencode(sorted(params.items()))
        full_path = f"{path}?{qs}".lower()
        data = {}
    else:
        full_path = path.lower()
        data = params

    e = {
        "url": full_path,
        "baseURL": "https://www.qcc.com",
        "data": data,
        "tid": tid,
        "headers": {}
    }
    return js_exec.call("main", e)
```

### 6.2 JS：main 入口

```javascript
function main(e) {
    if (e.tid) global.tid = e.tid;
    var t = e.url.replace(e.baseURL, "").toLowerCase();
    var i = bb(t, e.data);           // 计算 header 键名
    var u = r_default(t, e.data, global.tid);  // 计算 header 键值
    e.headers[i] = u;
    return { i, u };
}
```

---

## 七、注意事项

1. **Cookie / pid / tid 必须同源**：三者需来自同一浏览器会话、同一页面。
2. **path 必须精确匹配**：GET 的 path 需包含完整 query，且 key 排序、编码方式与前端一致。
3. **mapping 可能变更**：若网站更新，需从最新 `new_qichacha.js` 中重新提取 `mapping` 及算法。
4. **无会员限制**：招聘接口通常有页数限制（如 2 页内），超出可能返回 435 或空数据。
